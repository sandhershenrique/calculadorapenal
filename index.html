<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Calculadora Penal - Sistema Oficial</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg1:#0b0f17;
  --txt:#e5e7eb;
  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --shadow2: 0 10px 24px rgba(0,0,0,.35);
}
*{ box-sizing:border-box; }

body{
  margin:0;
  min-height:100vh;
  font-family:"Segoe UI", system-ui, -apple-system, Arial, sans-serif;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(59,130,246,.18), transparent 55%),
    radial-gradient(1000px 700px at 80% 10%, rgba(34,197,94,.10), transparent 55%),
    linear-gradient(135deg,var(--bg1),#111827);
  color:var(--txt);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:22px 14px 28px;
}

h1{
  display:flex;
  align-items:center;
  gap:14px;
  font-size:28px;
  letter-spacing:2px;
  margin:10px 0 18px;
  color:#cfe2ff;
  text-transform:uppercase;
  user-select:none;
}
h1 img{
  width:58px;
  height:58px;
  object-fit:contain;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
}

.container{
  width: min(1100px, 95vw);
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
  background: linear-gradient(180deg, rgba(15,23,42,.72), rgba(15,23,42,.56));
  border: 1px solid rgba(148,163,184,.18);
  border-radius:16px;
  padding:16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(6px);
}
@media (max-width: 880px){
  .container{ grid-template-columns:1fr; }
}

.field{display:flex; flex-direction:column; gap:7px;}
label{font-size:12px; color:rgba(226,232,240,.85); letter-spacing:.4px;}

input, select, textarea{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.22);
  background: rgba(2,6,23,.55);
  color:#f8fafc;
  font-size:14px;
  outline:none;
  transition: .18s ease;
}
input::placeholder, textarea::placeholder{ color: rgba(148,163,184,.75); }
input:focus, select:focus, textarea:focus{
  border-color: rgba(59,130,246,.9);
  box-shadow: 0 0 0 4px rgba(59,130,246,.18);
  transform: translateY(-1px);
}
textarea{ resize:none; min-height:92px; }

/* crimes */
#crimesContainer{
  grid-column: 1 / -1;
  background: linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
  border: 1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:12px;
  max-height:260px;
  overflow:auto;
  box-shadow: var(--shadow2);
}
#crimesContainer::-webkit-scrollbar{ width:10px; }
#crimesContainer::-webkit-scrollbar-track{ background: rgba(255,255,255,.05); border-radius:999px; }
#crimesContainer::-webkit-scrollbar-thumb{ background: rgba(59,130,246,.45); border-radius:999px; }
#crimesContainer::-webkit-scrollbar-thumb:hover{ background: rgba(59,130,246,.65); }

.categoria{
  background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(11,18,34,.65));
  border: 1px solid rgba(148,163,184,.14);
  border-left: 4px solid rgba(59,130,246,.95);
  border-radius:14px;
  padding:12px 12px 10px;
  margin-bottom:12px;
}
.categoria h3{
  margin:0 0 10px;
  font-size:12px;
  color:#cfe2ff;
  letter-spacing:.8px;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:10px;
}
.categoria h3::before{
  content:"";
  width:10px; height:10px;
  border-radius:50%;
  background: rgba(59,130,246,.95);
  box-shadow: 0 0 0 6px rgba(59,130,246,.12);
}
.crime{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid transparent;
  transition:.15s ease;
}
.crime:hover{ background: rgba(59,130,246,.08); border-color: rgba(59,130,246,.18); }
.crime + .crime{ margin-top:6px; }

.crime input[type="checkbox"]{
  appearance:none;
  -webkit-appearance:none;
  width:20px;
  height:20px;
  border-radius:6px;
  border:1px solid rgba(148,163,184,.4);
  background: rgba(2,6,23,.55);
  display:inline-grid;
  place-items:center;
  cursor:pointer;
  transition:.15s ease;
  flex: 0 0 auto;
}
.crime input[type="checkbox"]::after{
  content:"";
  width:10px; height:10px;
  border-radius:3px;
  transform: scale(0);
  transition:.12s ease;
  background: #fff;
}
.crime input[type="checkbox"]:checked{
  background: rgba(59,130,246,.95);
  border-color: rgba(59,130,246,1);
  box-shadow: 0 0 0 4px rgba(59,130,246,.15);
}
.crime input[type="checkbox"]:checked::after{ transform: scale(1); }

/* reduções + total */
.reducao, .total, .history{
  background: linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35));
  border: 1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:14px;
  box-shadow: var(--shadow2);
}
.reducao h3, .history h3{
  margin:0 0 12px;
  font-size:12px;
  letter-spacing:.9px;
  color:#cfe2ff;
  text-transform:uppercase;
}
.check-group{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:10px 0;
  padding:10px;
  border-radius:12px;
  background: rgba(15,23,42,.45);
  border:1px solid rgba(148,163,184,.14);
}
.check-group span{
  width:160px;
  font-weight:700;
  font-size:13px;
  color:#f1f5f9;
  text-align:left;
}
.pill{ display:flex; gap:10px; margin-left:auto; }
.pill label{
  cursor:pointer;
  user-select:none;
  font-size:13px;
  font-weight:800;
  letter-spacing:.3px;
  color: rgba(226,232,240,.85);
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.16);
  background: rgba(2,6,23,.35);
  transition:.15s ease;
}
.pill label:hover{ transform: translateY(-1px); border-color: rgba(59,130,246,.28); }
.pill input{ width:18px; height:18px; margin:0; }
.pill input[type="checkbox"]{
  appearance:none;
  -webkit-appearance:none;
  border-radius:6px;
  border:1px solid rgba(148,163,184,.35);
  background: rgba(2,6,23,.5);
  display:grid;
  place-items:center;
  transition:.12s ease;
}
.pill input[type="checkbox"]::after{
  content:"";
  width:10px; height:10px;
  border-radius:3px;
  transform: scale(0);
  transition:.12s ease;
  background:#fff;
}
.pill input[type="checkbox"]:checked{
  background: rgba(34,197,94,.95);
  border-color: rgba(34,197,94,1);
  box-shadow: 0 0 0 4px rgba(34,197,94,.15);
}
.pill label.no input[type="checkbox"]:checked{
  background: rgba(239,68,68,.95);
  border-color: rgba(239,68,68,1);
  box-shadow: 0 0 0 4px rgba(239,68,68,.15);
}
.pill input[type="checkbox"]:checked::after{ transform: scale(1); }

.total{ font-size:14px; line-height:1.6; }
.total span{ font-weight:900; color:#fff; }
.total .row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  border-radius:10px;
  background: rgba(15,23,42,.45);
  border:1px solid rgba(148,163,184,.12);
  margin:6px 0;
}

#btnAplicar{
  grid-column: 1 / -1;
  width:100%;
  padding:14px 14px;
  border-radius:14px;
  border:1px solid rgba(59,130,246,.35);
  background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95));
  color:#fff;
  font-weight:900;
  letter-spacing:1px;
  text-transform:uppercase;
  cursor:pointer;
  transition:.16s ease;
  box-shadow: 0 16px 30px rgba(37,99,235,.25);
}
#btnAplicar:hover{ transform: translateY(-1px); box-shadow: 0 18px 38px rgba(37,99,235,.30); }
#btnAplicar:active{ transform: translateY(0px) scale(.99); }

/* loading panel */
#loadingPanel{
  grid-column: 1 / -1;
  display:none;
  background: linear-gradient(180deg, rgba(2,6,23,.60), rgba(2,6,23,.40));
  border: 1px solid rgba(148,163,184,.18);
  border-radius:14px;
  padding:14px;
  box-shadow: var(--shadow2);
}
#loadingTitle{
  font-weight:900;
  letter-spacing:1px;
  text-transform:uppercase;
  color:#eaf2ff;
  margin-bottom:8px;
}
#loadingStatus{
  color: rgba(226,232,240,.85);
  font-weight:800;
  margin-bottom:10px;
  text-transform:uppercase;
  letter-spacing:.6px;
}
.progressWrap{
  width:100%;
  height:12px;
  border-radius:999px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(148,163,184,.16);
  overflow:hidden;
}
#progressBar{
  width:0%;
  height:100%;
  border-radius:999px;
  background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(34,197,94,.95));
  transition: width .12s linear;
}
#loadingDone{
  display:none;
  margin-top:12px;
  font-weight:1000;
  letter-spacing:1px;
  text-transform:uppercase;
  padding:12px;
  border-radius:12px;
  text-align:center;
  background: rgba(34,197,94,.14);
  border:1px solid rgba(34,197,94,.35);
  color: #86efac;
}

/* ===== HISTÓRICO ===== */
.history{ grid-column: 1 / -1; }
.historyTop{
  display:flex;
  gap:10px;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.historyBadge{
  font-size:12px;
  font-weight:900;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.20);
  background: rgba(15,23,42,.40);
  color: rgba(226,232,240,.92);
}
.historyList{
  max-height: 260px;
  overflow:auto;
  border-radius:12px;
  border:1px solid rgba(148,163,184,.16);
  background: rgba(15,23,42,.35);
  padding:10px;
}
.historyList::-webkit-scrollbar{ width:10px; }
.historyList::-webkit-scrollbar-track{ background: rgba(255,255,255,.05); border-radius:999px; }
.historyList::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.20); border-radius:999px; }
.historyList::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.28); }

.hItem{
  border:1px solid rgba(148,163,184,.14);
  background: rgba(2,6,23,.35);
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}
.hItem:last-child{ margin-bottom:0; }
.hRow{
  display:flex;
  flex-wrap:wrap;
  gap:10px 14px;
  align-items:center;
  font-size:13px;
  color: rgba(226,232,240,.92);
}
.hRow strong{ color:#fff; }
.hMeta{
  font-size:12px;
  color: rgba(226,232,240,.70);
  margin-top:6px;
  line-height:1.35;
}
.hMiniTitle{
  font-size:12px;
  font-weight:900;
  text-transform:uppercase;
  letter-spacing:.7px;
  color:#cfe2ff;
  margin:10px 0 6px;
}
.hEmpty{
  color: rgba(226,232,240,.70);
  font-size:13px;
  padding:10px;
}

/* modal com scroll */
#modalOverlay{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,0.62);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  padding:16px;
  overflow:auto;
}

/* relatório */
#resultadoFinal{
  width:820px;
  max-width:95%;
  max-height: 86vh;
  overflow-y: auto;
  padding:34px;

  background:#ffffff;
  color:#111;
  border-radius:12px;
  position:relative;
  box-shadow:0 0 30px rgba(0,0,0,0.6);
  font-family:"Times New Roman", serif;

  background-image:
    radial-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
    linear-gradient(0deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00));
  background-size: 14px 14px, 100% 100%;
  transform: translateZ(0);
  -webkit-font-smoothing: antialiased;
  text-rendering: geometricPrecision;
}

#resultadoFinal.capturando{
  max-height:none !important;
  overflow:visible !important;
}
#resultadoFinal.capturando .closeBtn{ display:none !important; }

.closeBtn{
  position:sticky;
  top:10px;
  margin-left:auto;
  width:36px;
  height:36px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
  cursor:pointer;
  color:#111;
  background: rgba(0,0,0,.06);
  user-select:none;
}
.closeBtn:hover{ background: rgba(0,0,0,.10); }

.relatorio-header{
  display:flex;
  align-items:center;
  margin-bottom:18px;
  padding-bottom:12px;
  border-bottom:2px solid #111;
}
.relatorio-header img{
  width:78px; height:78px;
  margin-right:18px;
  object-fit:contain;
}
.relatorio-titulo{
  font-size:26px;
  font-weight:bold;
  color:#111;
  letter-spacing:.5px;
}
.subtitulo{ font-size:13px; color:#444; margin-top:3px; }
.bloco{ margin-top:14px; }
.bloco h3{
  color:#111;
  border-bottom:1px solid #333;
  padding-bottom:5px;
  margin-bottom:8px;
}
.linha{ margin:6px 0; font-size:14px; line-height:1.3; }
.totalBox{
  font-weight:bold;
  margin-top:10px;
  padding:10px;
  border:1px solid #111;
  border-radius:8px;
  background:rgba(0,0,0,0.03);
}
#termoTexto{ white-space:pre-line; font-size:14px; line-height:1.45; color:#111; }
.termo-box{
  border:1px dashed rgba(0,0,0,.45);
  background: rgba(0,0,0,0.02);
  padding:12px;
  border-radius:10px;
}
.relatorio-fechar-final{
  margin-top:18px;
  padding-top:12px;
  border-top:1px dashed rgba(0,0,0,.35);
  display:flex;
  justify-content:flex-end;
}
.relatorio-fechar-final button{
  background: #111;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
}
.relatorio-fechar-final button:hover{ opacity:.9; }
</style>
</head>

<body>

<h1>
  <img src="foto.png" alt="Logo Polícia">
  CALCULADORA PENAL
</h1>

<div class="container">

  <div class="field">
    <label>Nome do Policial</label>
    <input id="policial" placeholder="Ex: João Silva">
  </div>

  <div class="field">
    <label>Passaporte do Policial (ID)</label>
    <input id="idpolicial" placeholder="Ex: 12345">
  </div>

  <div class="field">
    <label>Nome do Infrator</label>
    <input id="suspeito" placeholder="Ex: Carlos Pereira">
  </div>

  <div class="field">
    <label>Passaporte do Infrator (ID)</label>
    <input id="idsuspeito" placeholder="Ex: 67890">
  </div>

  <!-- ✅ HISTÓRICO CRIMINAL -->
  <div class="history">
    <div class="historyTop">
      <h3 style="margin:0;">Histórico Criminal</h3>
      <div class="historyBadge" id="historyBadge">ID: — | Registros: 0</div>
    </div>
    <div class="historyList" id="historyList">
      <div class="hEmpty">Digite o ID do infrator para puxar o histórico automaticamente.</div>
    </div>
  </div>

  <div class="field">
    <label>A qual organização você participa?</label>
    <select id="organizacao">
      <option value="POLÍCIA CIVIL">POLÍCIA CIVIL</option>
      <option value="POLÍCIA MILITAR">POLÍCIA MILITAR</option>
      <option value="RONE">RONE</option>
      <option value="POLÍCIA RODOVIÁRIA FEDERAL">POLÍCIA RODOVIÁRIA FEDERAL</option>
      <option value="POLÍCIA FEDERAL">POLÍCIA FEDERAL</option>
    </select>
  </div>

  <div id="crimesContainer"></div>

  <div class="reducao">
    <h3>Finalização - Reduções</h3>

    <div class="check-group">
      <span>Réu primário</span>
      <div class="pill">
        <label class="yes"><input type="checkbox" name="reu" value="sim" onclick="unico(this);calcular()">SIM</label>
        <label class="no"><input type="checkbox" name="reu" value="nao" onclick="unico(this);calcular()">NÃO</label>
      </div>
    </div>

    <div class="check-group">
      <span>Bom comportamento</span>
      <div class="pill">
        <label class="yes"><input type="checkbox" name="bom" value="sim" onclick="unico(this);calcular()">SIM</label>
        <label class="no"><input type="checkbox" name="bom" value="nao" onclick="unico(this);calcular()">NÃO</label>
      </div>
    </div>

    <div class="check-group">
      <span>Ficha limpa</span>
      <div class="pill">
        <label class="yes"><input type="checkbox" name="ficha" value="sim" onclick="unico(this);calcular()">SIM</label>
        <label class="no"><input type="checkbox" name="ficha" value="nao" onclick="unico(this);calcular()">NÃO</label>
      </div>
    </div>
  </div>

  <div class="total">
    <div class="row">Meses Totais <span id="meses">0</span></div>
    <div class="row">Multa Total <span>$<span id="multa">0</span></span></div>
    <div class="row">Fiança Total <span>$<span id="fianca">0</span></span></div>
    <div class="row">Total Geral <span>$<span id="total">0</span></span></div>
  </div>

  <div class="field" style="grid-column:1/-1;">
    <label>Observações do policial</label>
    <textarea id="obs" placeholder="Digite aqui..."></textarea>
  </div>

  <button id="btnAplicar" onclick="gerarRelatorio()">APLICAR PENA</button>

  <div id="loadingPanel">
    <div id="loadingTitle">CARREGANDO DADOS</div>
    <div id="loadingStatus">carregando dados</div>
    <div class="progressWrap"><div id="progressBar"></div></div>
    <div id="loadingDone">REGISTRO FEITO COM SUCESSO</div>
  </div>
</div>

<div id="modalOverlay">
  <div id="resultadoFinal">
    <div class="closeBtn" onclick="fecharRelatorio()">X</div>

    <div class="relatorio-header">
      <img src="foto.png" alt="Logo Polícia">
      <div>
        <div class="relatorio-titulo">RELATÓRIO PENAL OFICIAL</div>
        <div class="subtitulo">Departamento de Polícia - Sistema Judicial</div>
      </div>
    </div>

    <div id="dados" class="bloco"></div>

    <div class="bloco">
      <h3>Infrações Registradas</h3>
      <div id="listaCrimes"></div>
    </div>

    <div class="bloco">
      <h3>Observações do Policial</h3>
      <div id="observacaoFinal"></div>
    </div>

    <div class="bloco">
      <h3>Termo / Declaração</h3>
      <div class="termo-box">
        <div id="termoTexto"></div>
      </div>
    </div>

    <div class="bloco" id="protocoloBloco">
      <h3>Protocolo e Data</h3>
      <div id="protocolo"></div>
      <div id="dataHora"></div>
    </div>

    <div class="relatorio-fechar-final">
      <button type="button" onclick="fecharRelatorio()">(x) FECHAR</button>
    </div>
  </div>
</div>

<script>
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1471684006901842001/vQFiUpag8t2xCAR7pzx0Al_gepXby2ZrY3p1jeVDSAhUynfXwxOE36l7guhsYwO1g0yc";

/* =========================
   CRIMES
========================= */
const categorias = [
  {titulo:"ITENS ILEGAIS – ART. 2º", dados:[
      {num:"2.2", nome:"Drogas uso próprio", meses:0, multa:6250, fianca:0},
      {num:"2.3", nome:"Dinheiro sujo < 100k", meses:0, multa:6250, fianca:0},
      {num:"2.4", nome:"Algemas/capuz/keycard", meses:6, multa:6250, fianca:6250},
      {num:"2.5", nome:"Masterpick/lockpick", meses:6, multa:6250, fianca:6250},
      {num:"2.6", nome:"Colete balístico", meses:13, multa:12500, fianca:12500},
      {num:"2.7", nome:"Veículo clonado", meses:13, multa:12500, fianca:12500},
      {num:"2.8", nome:"Dinheiro sujo ≥100k", meses:13, multa:12500, fianca:12500},
      {num:"2.9", nome:"Itens ilegais", meses:19, multa:18750, fianca:18750},
      {num:"2.10", nome:"Tráfico de drogas", meses:19, multa:18750, fianca:18750},
      {num:"2.11", nome:"Munição ilegal", meses:19, multa:18750, fianca:18750}
  ]},
  {titulo:"CRIMES DE TRÂNSITO – ART. 1º", dados:[
      {num:"1.1", nome:"Alta velocidade", meses:0, multa:3125, fianca:0},
      {num:"1.2", nome:"Estacionar proibido", meses:0, multa:12500, fianca:0},
      {num:"1.3", nome:"Abandono veículo", meses:0, multa:12500, fianca:0},
      {num:"1.4", nome:"Fila dupla", meses:0, multa:12500, fianca:0},
      {num:"1.5", nome:"Som alto", meses:0, multa:12500, fianca:0},
      {num:"1.6", nome:"Bloquear via", meses:0, multa:12500, fianca:0},
      {num:"1.7", nome:"Manobras perigosas", meses:6, multa:12500, fianca:12500},
      {num:"1.8", nome:"Direção perigosa", meses:6, multa:12500, fianca:12500},
      {num:"1.9", nome:"Dirigir sob efeito", meses:6, multa:12500, fianca:12500}
  ]},
  {titulo:"CRIMES INAFIANÇÁVEIS – ART. 4º", dados:[
      {num:"4.1", nome:"Sequestro", meses:50, multa:50000, fianca:50000},
      {num:"4.2", nome:"Porte arma alto calibre", meses:50, multa:50000, fianca:50000},
      {num:"4.3", nome:"Tráfico de armas", meses:50, multa:50000, fianca:50000},
      {num:"4.4", nome:"Tráfico de munições", meses:50, multa:50000, fianca:50000},
      {num:"4.5", nome:"Desacato servidor público", meses:50, multa:50000, fianca:50000},
      {num:"4.6", nome:"Abuso de poder", meses:63, multa:62500, fianca:62500},
      {num:"4.7", nome:"Assalto banco/joalheria", meses:75, multa:75000, fianca:75000},
      {num:"4.8", nome:"Corrupção passiva", meses:75, multa:75000, fianca:75000},
      {num:"4.9", nome:"Latrocínio", meses:75, multa:75000, fianca:75000},
      {num:"4.10", nome:"Homicídio doloso", meses:75, multa:75000, fianca:75000}
  ]}
];

const crimesDiv = document.getElementById("crimesContainer");
categorias.forEach((cat,ci)=>{
  let html=`<div class="categoria"><h3>${cat.titulo}</h3>`;
  cat.dados.forEach((c,i)=>{
    html+=`<div class="crime">
      <input type="checkbox" onchange="calcular()" data-cat="${ci}" data-i="${i}">
      <div style="display:flex; flex-direction:column; gap:2px;">
        <div style="font-weight:800; color:#eaf2ff;">${c.num} - ${c.nome}</div>
        <div style="font-size:12px; color:rgba(226,232,240,.70);">Pena base: ${c.meses} meses</div>
      </div>
    </div>`;
  });
  html+="</div>";
  crimesDiv.innerHTML+=html;
});

function unico(el){
  document.getElementsByName(el.name).forEach(x=>{ if(x!==el) x.checked=false; });
}

function calcular(){
  let meses=0,multa=0,fianca=0;
  document.querySelectorAll('#crimesContainer input:checked').forEach(el=>{
    let c=categorias[el.dataset.cat].dados[el.dataset.i];
    meses+=c.meses; multa+=c.multa; fianca+=c.fianca;
  });

  let red=0;
  if(document.querySelector('[name=reu][value=sim]')?.checked) red+=0.05;
  if(document.querySelector('[name=bom][value=sim]')?.checked) red+=0.10;
  if(document.querySelector('[name=ficha][value=sim]')?.checked) red+=0.05;

  meses=Math.round(meses-(meses*red));
  document.getElementById("meses").innerText=meses;
  document.getElementById("multa").innerText=multa;
  document.getElementById("fianca").innerText=fianca;
  document.getElementById("total").innerText=multa+fianca;
}

function limparNomeArquivo(str){
  return String(str || "SEM_NOME")
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[\\/:*?"<>|]/g, "")
    .replace(/[^\p{L}\p{N}_-]+/gu, "")
    .slice(0, 80);
}

async function esperarImagensDentro(el){
  const imgs = Array.from(el.querySelectorAll("img"));
  await Promise.all(imgs.map(img => {
    if (img.complete && img.naturalWidth > 0) return Promise.resolve();
    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
  }));
}

function fecharRelatorio(){
  document.getElementById('modalOverlay').style.display='none';
}

function iniciarLoading8s(){
  const panel = document.getElementById("loadingPanel");
  const status = document.getElementById("loadingStatus");
  const bar = document.getElementById("progressBar");
  const done = document.getElementById("loadingDone");

  panel.style.display = "block";
  done.style.display = "none";
  status.style.color = "rgba(226,232,240,.85)";
  status.textContent = "carregando dados";
  bar.style.width = "0%";

  const totalMs = 8000;
  const stepMs = 80;
  const steps = Math.floor(totalMs / stepMs);
  let i = 0;

  return new Promise(resolve=>{
    const timer = setInterval(()=>{
      i++;
      const pct = Math.min(100, Math.round((i/steps)*100));
      bar.style.width = pct + "%";
      status.textContent = (pct >= 50) ? "registrando" : "carregando dados";

      if (pct >= 100){
        clearInterval(timer);
        status.textContent = "registro feito com sucesso";
        status.style.color = "#86efac";
        done.style.display = "block";
        resolve();
      }
    }, stepMs);
  });
}

/* =========================
   HISTÓRICO (localStorage)
========================= */
function historyKeyById(id){
  const clean = String(id || "").trim();
  return clean ? `HISTORICO_INFRATOR_${clean}` : null;
}

function loadHistoryById(id){
  const key = historyKeyById(id);
  if(!key) return [];
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : [];
  }catch(e){
    return [];
  }
}

function saveHistoryById(id, records){
  const key = historyKeyById(id);
  if(!key) return;
  try{
    localStorage.setItem(key, JSON.stringify(records));
  }catch(e){}
}

function getSelectedCrimes(){
  const arr = [];
  document.querySelectorAll('#crimesContainer input:checked').forEach(el=>{
    const c = categorias[el.dataset.cat].dados[el.dataset.i];
    arr.push({ num:c.num, nome:c.nome, meses:c.meses });
  });
  return arr;
}

function renderHistory(id){
  const list = document.getElementById("historyList");
  const badge = document.getElementById("historyBadge");
  const cleanId = String(id || "").trim();

  if(!cleanId){
    badge.textContent = `ID: — | Registros: 0`;
    list.innerHTML = `<div class="hEmpty">Digite o ID do infrator para puxar o histórico automaticamente.</div>`;
    return;
  }

  const records = loadHistoryById(cleanId);
  badge.textContent = `ID: ${cleanId} | Registros: ${records.length}`;

  if(records.length === 0){
    list.innerHTML = `<div class="hEmpty">Nenhum registro encontrado para este ID.</div>`;
    return;
  }

  list.innerHTML = records.map(r=>{
    const crimesTxt = (r.crimes || []).map(x=>`${x.num} - ${x.nome} (${x.meses}m)`).join(" | ");
    return `
      <div class="hItem">
        <div class="hRow">
          <div><strong>${r.dataHora}</strong></div>
          <div>• Protocolo: <strong>${r.protocolo}</strong></div>
          <div>• Meses: <strong>${r.meses}</strong></div>
          <div>• Total: <strong>$${r.total}</strong></div>
        </div>
        <div class="hMeta">
          <div><strong>Policial:</strong> ${r.policial} (${r.idPolicial})</div>
          <div><strong>Organização:</strong> ${r.organizacao}</div>
          <div class="hMiniTitle">Infrações</div>
          <div>${crimesTxt || "Nenhuma infração registrada."}</div>
          ${r.obs ? `<div class="hMiniTitle">Observações</div><div>${String(r.obs).replace(/</g,"&lt;")}</div>` : ""}
        </div>
      </div>
    `;
  }).join("");
}

function addRecordToHistory(idInfrator, record){
  const cleanId = String(idInfrator || "").trim();
  if(!cleanId) return;

  const records = loadHistoryById(cleanId);
  records.unshift(record);
  // mantém no máximo 20
  const limited = records.slice(0, 20);
  saveHistoryById(cleanId, limited);
  renderHistory(cleanId);
}

// puxar histórico automaticamente ao digitar o ID
document.getElementById("idsuspeito").addEventListener("input", (e)=>{
  renderHistory(e.target.value);
});

/* =========================
   RELATÓRIO + REGISTRO
========================= */
async function gerarRelatorio(){
  document.getElementById("btnAplicar").style.display="none";

  await iniciarLoading8s();

  const nomePolicial = (document.getElementById("policial").value || "").trim();
  const idPolicial = (document.getElementById("idpolicial").value || "").trim();
  const nomeInfrator = (document.getElementById("suspeito").value || "").trim();
  const idInfrator = (document.getElementById("idsuspeito").value || "").trim();
  const organizacao = document.getElementById("organizacao").value;
  const obs = (document.getElementById("obs").value || "").trim();

  const protocolo = "PROT-" + Math.floor(100000 + Math.random() * 900000);
  const now = new Date();
  const dataHora = now.toLocaleString('pt-BR', {hour12:false});

  // ✅ registra no histórico (localStorage)
  const crimesSelecionados = getSelectedCrimes();
  addRecordToHistory(idInfrator, {
    protocolo,
    dataHora,
    policial: nomePolicial || "—",
    idPolicial: idPolicial || "—",
    infrator: nomeInfrator || "—",
    idInfrator: idInfrator || "—",
    organizacao: organizacao || "—",
    meses: document.getElementById("meses").innerText,
    multa: document.getElementById("multa").innerText,
    fianca: document.getElementById("fianca").innerText,
    total: document.getElementById("total").innerText,
    crimes: crimesSelecionados,
    obs
  });

  // montar relatório
  document.getElementById("dados").innerHTML = `
    <div class="linha"><strong>Policial:</strong> ${nomePolicial} (${idPolicial})</div>
    <div class="linha"><strong>Infrator:</strong> ${nomeInfrator} (${idInfrator})</div>
    <div class="linha"><strong>Organização:</strong> ${organizacao}</div>
    <div class="linha totalBox">Meses: ${document.getElementById("meses").innerText} | Multa: $${document.getElementById("multa").innerText} | Fiança: $${document.getElementById("fianca").innerText} | Total: $${document.getElementById("total").innerText}</div>
  `;

  let lista="";
  crimesSelecionados.forEach(c=>{
    lista+=`<div class="linha">${c.num} - ${c.nome} (${c.meses} meses)</div>`;
  });
  document.getElementById("listaCrimes").innerHTML = lista || `<div class="linha">Nenhuma infração marcada.</div>`;
  document.getElementById("observacaoFinal").innerText = obs || "Sem observações.";

  document.getElementById("protocolo").innerText = protocolo;
  document.getElementById("dataHora").innerText = dataHora;

  const termo = `Eu, ${nomePolicial} portador do documento (${idPolicial}), na qualidade de policial responsável pelo procedimento, registro que o(a) indivíduo ${nomeInfrator}, portador do documento (${idInfrator}), foi devidamente submetido(a) às medidas legais cabíveis conforme a legislação vigente da cidade de Maringá.

O presente relatório possui caráter oficial e administrativo, sendo firmado para fins de registro e controle interno.

${dataHora}`;
  document.getElementById("termoTexto").innerText = termo;

  // abre modal
  document.getElementById("modalOverlay").style.display = "flex";

  // captura inteira (sem cortar)
  const resultadoDiv = document.getElementById("resultadoFinal");
  resultadoDiv.classList.add("capturando");

  if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(e){} }
  await esperarImagensDentro(resultadoDiv);
  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

  const scale = Math.max(2.5, (window.devicePixelRatio || 1) * 2);

  try{
    const canvas = await html2canvas(resultadoDiv, {
      backgroundColor: "#ffffff",
      scale,
      useCORS: true,
      allowTaint: false,
      logging: false,
      imageTimeout: 15000,
      windowWidth: resultadoDiv.scrollWidth,
      windowHeight: resultadoDiv.scrollHeight
    });

    canvas.toBlob(async function(blob){
      if(!blob){
        alert("Falha ao gerar a imagem do relatório.");
        return;
      }

      const suspeito = limparNomeArquivo(nomeInfrator);
      const idsus = limparNomeArquivo(idInfrator);
      const nomeArquivo = `${suspeito}_${idsus}.png`;

      // download automático
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = nomeArquivo;
      document.body.appendChild(link);
      link.click();
      link.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);

      // envio para Discord
      const formData = new FormData();
      formData.append("file", blob, nomeArquivo);
      formData.append("payload_json", JSON.stringify({
        content: `Relatório Penal - ${nomeArquivo}\nProtocolo: ${protocolo} | Data/Hora: ${dataHora}`
      }));

      try{
        const res = await fetch(DISCORD_WEBHOOK, { method:"POST", body: formData });
        if(!res.ok) console.warn("Discord respondeu erro:", res.status);
      }catch(err){
        console.warn("Erro ao enviar pro Discord:", err);
      }
    }, "image/png", 1.0);

  } finally {
    resultadoDiv.classList.remove("capturando");
  }
}

// inicializa histórico vazio ao carregar
renderHistory(document.getElementById("idsuspeito").value);
</script>

</body>
</html>
